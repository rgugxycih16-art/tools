<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>äºŒç»´ç æ–‡å­—äº’è½¬å·¥å…·</title>

  <!-- äºŒç»´ç ç”Ÿæˆåº“ï¼šæ¢æˆæµè§ˆå™¨å…¼å®¹æ›´å¥½çš„ qrcodejs -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- äºŒç»´ç è¯†åˆ«åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:20px;
    }
    .container { max-width:600px; margin:0 auto; background:#fff; border-radius:20px; padding:30px; box-shadow:0 20px 60px rgba(0,0,0,.3); }
    h1 { text-align:center; color:#333; margin-bottom:10px; font-size:28px; }
    .subtitle { text-align:center; color:#666; margin-bottom:30px; font-size:14px; }
    .tabs { display:flex; gap:10px; margin-bottom:30px; background:#f8f9ff; padding:5px; border-radius:15px; }
    .tab { flex:1; padding:12px; border:none; background:transparent; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; transition:.3s; color:#667eea; }
    .tab.active { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; box-shadow:0 4px 15px rgba(102,126,234,.4); }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .input-group { margin-bottom:20px; }
    .input-group label { display:block; margin-bottom:8px; color:#333; font-weight:600; }
    textarea {
      width:100%; min-height:120px; padding:15px; border:2px solid #e0e0e0; border-radius:10px;
      font-size:15px; font-family:inherit; resize:vertical; transition:border-color .3s;
    }
    textarea:focus { outline:none; border-color:#667eea; }
    .size-selector { display:flex; gap:10px; margin-bottom:20px; }
    .size-selector label { flex:1; }
    .size-selector select {
      width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:10px; font-size:16px;
    }
    button {
      width:100%; padding:15px; border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; transition:.3s;
    }
    .btn-primary { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; margin-bottom:20px; }
    .btn-primary:active { transform:scale(.98); }
    .btn-secondary { background:#f0f2ff; color:#667eea; margin-bottom:10px; }
    .qr-result { text-align:center; margin-top:20px; display:none; }
    #qrBox { width:100%; display:grid; place-items:center; margin-top:10px; }
    #qrBox canvas, #qrBox img {
      max-width:100%; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,.1); margin-bottom:15px;
    }
    .upload-area {
      border:3px dashed #667eea; border-radius:15px; padding:40px 20px; text-align:center; cursor:pointer;
      transition:.3s; background:#f8f9ff; margin-bottom:20px;
    }
    .upload-area:hover { border-color:#764ba2; background:#f0f2ff; }
    .upload-area.dragover { border-color:#764ba2; background:#e8ebff; transform:scale(1.02); }
    .upload-icon { font-size:48px; margin-bottom:10px; }
    .upload-text { color:#667eea; font-size:16px; font-weight:600; }
    .upload-hint { color:#999; font-size:12px; margin-top:5px; }
    #fileInput { display:none; }
    .scan-buttons { display:flex; gap:10px; margin-bottom:20px; }
    .scan-buttons button { flex:1; }
    #preview { max-width:100%; border-radius:10px; margin-bottom:20px; display:none; box-shadow:0 4px 15px rgba(0,0,0,.1); }
    .decode-result { display:none; margin-top:20px; }
    .result-label { font-weight:600; color:#333; margin-bottom:10px; }
    #decodeText {
      width:100%; min-height:120px; padding:15px; border:2px solid #e0e0e0; border-radius:10px;
      font-size:15px; line-height:1.6; resize:vertical; font-family:inherit; margin-bottom:10px;
    }
    .action-buttons { display:flex; gap:10px; }
    .action-buttons button { flex:1; }
    #videoContainer { display:none; position:relative; margin-bottom:20px; }
    #video { width:100%; border-radius:10px; background:#000; }
    #scanOverlay {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      width:200px; height:200px; border:3px solid #00ff00; border-radius:10px; box-shadow:0 0 0 9999px rgba(0,0,0,.5);
    }
    .footer { text-align:center; margin-top:20px; color:#999; font-size:12px; }
    @media (max-width:480px) { .container{padding:20px;} h1{font-size:24px;} .upload-area{padding:30px 15px;} }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”² äºŒç»´ç å·¥å…·</h1>
    <p class="subtitle">æ–‡å­—ä¸äºŒç»´ç äº’ç›¸è½¬æ¢</p>

    <div class="tabs">
      <!-- ä¼ å…¥ eventï¼Œé¿å… Safari æ— å…¨å±€ event æŠ¥é”™ -->
      <button class="tab active" onclick="switchTab(event, 'generate')">ğŸ“ ç”ŸæˆäºŒç»´ç </button>
      <button class="tab" onclick="switchTab(event, 'scan')">ğŸ“· æ‰«æäºŒç»´ç </button>
    </div>

    <!-- æ–‡å­— -> äºŒç»´ç  -->
    <div id="generate" class="tab-content active">
      <div class="input-group">
        <label for="inputText">è¾“å…¥æ–‡å­—å†…å®¹:</label>
        <textarea id="inputText" placeholder="è¾“å…¥è¦ç”ŸæˆäºŒç»´ç çš„æ–‡å­—ã€ç½‘å€æˆ–å…¶ä»–å†…å®¹..."></textarea>
      </div>

      <div class="size-selector">
        <label>
          å¤§å°:
          <select id="qrSize">
            <option value="200">å° (200x200)</option>
            <option value="300" selected>ä¸­ (300x300)</option>
            <option value="400">å¤§ (400x400)</option>
            <option value="500">è¶…å¤§ (500x500)</option>
          </select>
        </label>
        <label>
          çº é”™çº§åˆ«:
          <select id="errorLevel">
            <option value="L">ä½ (L)</option>
            <option value="M" selected>ä¸­ (M)</option>
            <option value="Q">è¾ƒé«˜ (Q)</option>
            <option value="H">é«˜ (H)</option>
          </select>
        </label>
      </div>

      <button class="btn-primary" onclick="generateQR()">ğŸ”² ç”ŸæˆäºŒç»´ç </button>

      <div class="qr-result" id="qrResult">
        <!-- ç”¨ qrcodejsï¼šéœ€è¦ä¸€ä¸ªå®¹å™¨ï¼Œè€Œä¸æ˜¯å›ºå®šçš„ <canvas> -->
        <div id="qrBox" aria-label="QR Code"></div>
        <button class="btn-secondary" onclick="downloadQR()">ğŸ’¾ ä¸‹è½½äºŒç»´ç </button>
        <button class="btn-secondary" onclick="shareQR()">ğŸ“¤ åˆ†äº«äºŒç»´ç </button>
      </div>
    </div>

    <!-- äºŒç»´ç  -> æ–‡å­— -->
    <div id="scan" class="tab-content">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ğŸ“¸</div>
        <div class="upload-text">ç‚¹å‡»é€‰æ‹©äºŒç»´ç å›¾ç‰‡æˆ–æ‹–æ”¾åˆ°æ­¤å¤„</div>
        <div class="upload-hint">æ”¯æŒ JPGã€PNG ç­‰æ ¼å¼</div>
      </div>
      <input type="file" id="fileInput" accept="image/*" />

      <div class="scan-buttons">
        <button class="btn-primary" onclick="openCamera()">ğŸ“· æ‹ç…§æ‰«æ</button>
        <button class="btn-secondary" onclick="openGallery()">ğŸ–¼ï¸ ç›¸å†Œé€‰æ‹©</button>
      </div>

      <button class="btn-primary" id="liveButton" onclick="startLiveScan()">ğŸ“¹ å®æ—¶æ‰«æ</button>

      <div id="videoContainer">
        <video id="video" autoplay playsinline></video>
        <div id="scanOverlay"></div>
        <button class="btn-secondary" onclick="stopLiveScan()">â¹ï¸ åœæ­¢æ‰«æ</button>
      </div>

      <img id="preview" alt="é¢„è§ˆå›¾ç‰‡" />

      <div class="decode-result" id="decodeResult">
        <div class="result-label">è¯†åˆ«ç»“æœ:</div>
        <textarea id="decodeText" readonly></textarea>
        <div class="action-buttons">
          <button class="btn-primary" onclick="copyResult()">ğŸ“‹ å¤åˆ¶</button>
          <button class="btn-secondary" onclick="openLink()">ğŸ”— æ‰“å¼€é“¾æ¥</button>
          <button class="btn-secondary" onclick="resetScan()">ğŸ”„ é‡æ–°æ‰«æ</button>
        </div>
      </div>
    </div>

    <div class="footer">æ‰€æœ‰å¤„ç†åœ¨æœ¬åœ°å®Œæˆï¼Œä¿æŠ¤æ‚¨çš„éšç§</div>
  </div>

  <script>
    let videoStream = null;
    let scanning = false;
    let qr; // qrcodejs å®ä¾‹

    // Tab åˆ‡æ¢ï¼ˆæ˜¾å¼æ¥æ”¶ eventï¼‰
    function switchTab(ev, tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      if (ev && ev.currentTarget) ev.currentTarget.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      if (tabName === 'generate') stopLiveScan();
    }

    // ========= æ–‡å­— -> äºŒç»´ç  =========
    function generateQR() {
      const value = (document.getElementById('inputText').value || '').trim();
      const size = parseInt(document.getElementById('qrSize').value, 10);
      const level = document.getElementById('errorLevel').value;

      if (!value) { alert('è¯·è¾“å…¥è¦ç”ŸæˆäºŒç»´ç çš„å†…å®¹ï¼'); return; }

      const box = document.getElementById('qrBox');
      box.innerHTML = ''; // æ¸…ç©ºæ—§çš„
      // qrcodejsï¼šH(æœ€é«˜)ã€Qã€Mã€L(æœ€ä½)
      const levelMap = { L:QRCode.CorrectLevel.L, M:QRCode.CorrectLevel.M, Q:QRCode.CorrectLevel.Q, H:QRCode.CorrectLevel.H };

      // åˆ›å»ºæ–°äºŒç»´ç 
      qr = new QRCode(box, {
        text: value,
        width: size,
        height: size,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: levelMap[level] ?? QRCode.CorrectLevel.M
      });

      // æ˜¾ç¤ºæ“ä½œåŒº
      document.getElementById('qrResult').style.display = 'block';
    }

    function getQRDataURL() {
      const box = document.getElementById('qrBox');
      const canvas = box.querySelector('canvas');
      const img = box.querySelector('img');
      if (canvas) return canvas.toDataURL('image/png');
      if (img && img.src) return img.src;
      return null;
    }

    function downloadQR() {
      const url = getQRDataURL();
      if (!url) return alert('æš‚æ— äºŒç»´ç ï¼Œè¯·å…ˆç”Ÿæˆ');
      const a = document.createElement('a');
      a.href = url; a.download = 'qrcode_' + Date.now() + '.png';
      document.body.appendChild(a); a.click(); a.remove();
    }

    async function shareQR() {
      const url = getQRDataURL();
      if (!url) return alert('æš‚æ— äºŒç»´ç ï¼Œè¯·å…ˆç”Ÿæˆ');
      const res = await fetch(url);
      const blob = await res.blob();
      const file = new File([blob], 'qrcode.png', { type: 'image/png' });
      if (navigator.share && navigator.canShare?.({ files:[file] })) {
        try { await navigator.share({ files:[file], title:'äºŒç»´ç ', text:'åˆ†äº«äºŒç»´ç ' }); }
        catch(e) { /* ç”¨æˆ·å–æ¶ˆ */ }
      } else {
        alert('æ­¤è®¾å¤‡/æµè§ˆå™¨ä¸æ”¯æŒç³»ç»Ÿåˆ†äº«ï¼Œè¯·ä½¿ç”¨ä¸‹è½½ã€‚');
      }
    }

    // ========= äºŒç»´ç å›¾ç‰‡ -> æ–‡å­— =========
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const decodeResult = document.getElementById('decodeResult');
    const decodeText = document.getElementById('decodeText');

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) handleImageFile(file);
    });
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault(); uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files?.[0];
      if (file && file.type.startsWith('image/')) handleImageFile(file);
    });

    function openCamera() {
      fileInput.setAttribute('capture', 'environment'); // ä¼˜å…ˆç›¸æœº
      fileInput.click();
    }
    function openGallery() {
      fileInput.removeAttribute('capture'); // ç›¸å†Œ/æ‹ç…§äºŒé€‰
      fileInput.click();
    }

    function handleImageFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result; preview.style.display = 'block';
        decodeQRCode(e.target.result);
      };
      reader.readAsDataURL(file);
    }

    function decodeQRCode(imageSrc) {
      const img = new Image();
      img.onload = () => {
        // ä¸ºæé€Ÿä¸å†…å­˜å®‰å…¨ï¼Œé™åˆ¶æœ€é•¿è¾¹ 1600
        const maxSide = 1600;
        const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently:true });
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);

        const imageData = ctx.getImageData(0, 0, w, h);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts:'attemptBoth' });

        if (code && code.data) {
          decodeText.value = code.data;
          decodeResult.style.display = 'block';
        } else {
          alert('æœªè¯†åˆ«åˆ°äºŒç»´ç ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”åŒ…å«äºŒç»´ç ');
        }
      };
      img.src = imageSrc;
    }

    // ========= å®æ—¶æ‰«æ =========
    const liveCanvas = document.createElement('canvas');
    const liveCtx = liveCanvas.getContext('2d', { willReadFrequently:true });

    function startLiveScan() {
      const videoContainer = document.getElementById('videoContainer');
      const video = document.getElementById('video');
      const liveButton = document.getElementById('liveButton');

      videoContainer.style.display = 'block';
      liveButton.style.display = 'none';
      decodeResult.style.display = 'none';
      preview.style.display = 'none';

      navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          scanning = true;
          requestAnimationFrame(scanFrame);
        })
        .catch(err => {
          alert('æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + (err.message || err));
          stopLiveScan();
        });
    }

    function scanFrame() {
      if (!scanning) return;
      const video = document.getElementById('video');
      if (video.readyState < 2) { requestAnimationFrame(scanFrame); return; }

      liveCanvas.width = video.videoWidth || 640;
      liveCanvas.height = video.videoHeight || 480;
      liveCtx.drawImage(video, 0, 0, liveCanvas.width, liveCanvas.height);

      const imageData = liveCtx.getImageData(0, 0, liveCanvas.width, liveCanvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts:'attemptBoth' });

      if (code && code.data) {
        decodeText.value = code.data;
        decodeResult.style.display = 'block';
        stopLiveScan();
        if (navigator.vibrate) navigator.vibrate(200);
      } else {
        requestAnimationFrame(scanFrame);
      }
    }

    function stopLiveScan() {
      scanning = false;
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
      document.getElementById('videoContainer').style.display = 'none';
      document.getElementById('liveButton').style.display = 'block';
    }

    // ========= ç»“æœæ“ä½œ =========
    function copyResult() {
      const txt = decodeText.value || '';
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(txt).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'));
      } else {
        decodeText.select(); document.execCommand('copy'); alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      }
    }

    function openLink() {
      const t = (decodeText.value || '').trim();
      if (/^https?:\/\/[\w\-\.]/i.test(t)) window.open(t, '_blank');
      else alert('è¯†åˆ«å†…å®¹ä¸æ˜¯ç½‘å€');
    }

    function resetScan() {
      preview.style.display = 'none';
      decodeResult.style.display = 'none';
      decodeText.value = '';
      fileInput.value = '';
    }

    // ç¦»å¼€é¡µé¢æ—¶åœæ­¢æ‘„åƒå¤´
    window.addEventListener('beforeunload', stopLiveScan);
  </script>
</body>
</html>